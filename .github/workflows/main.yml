name: Daily Stock Scan

on:
  # ğŸ” ìë™ ì‹¤í–‰ (UTC ê¸°ì¤€ â†’ KST 05:40~05:45)
  schedule:
    - cron: '40-45 20 * * *'

  # ğŸ– ìˆ˜ë™ ì‹¤í–‰ (ì‹œê°„ ë¬´ê´€)
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # â° ì‹œê°„ ì²´í¬ (Manualì€ ë¬´ì¡°ê±´ í†µê³¼, Scheduleë§Œ ì œí•œ)
      - name: Time window check (KST)
        id: timecheck
        run: |
          # Manual ì‹¤í–‰ì´ë©´ ë¬´ì¡°ê±´ ì‹¤í–‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run=yes" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ Manual ì‹¤í–‰ â†’ ì‹œê°„ ì²´í¬ ìŠ¤í‚µ"
            exit 0
          fi

          # Schedule ì‹¤í–‰ì¼ ê²½ìš°ë§Œ ì‹œê°„ ì²´í¬
          HOUR=$(TZ=Asia/Seoul date +%H)
          MIN=$(TZ=Asia/Seoul date +%M)
          NOW=$((10#$HOUR * 60 + 10#$MIN))

          START=$((5 * 60 + 40))   # 05:40
          END=$((5 * 60 + 45))     # 05:45

          echo "ğŸ•’ Current KST: ${HOUR}:${MIN}"

          if (( NOW >= START && NOW <= END )); then
            echo "run=yes" >> $GITHUB_OUTPUT
            echo "âœ… ì¢…ê°€ ë§¤ìˆ˜ ì‹¤í–‰ ì‹œê°„"
          else
            echo "run=no" >> $GITHUB_OUTPUT
            echo "â­ ì‹¤í–‰ ì‹œê°„ ì•„ë‹˜ â†’ ìŠ¤í‚µ"
          fi

      - name: Install dependencies
        if: steps.timecheck.outputs.run == 'yes'
        run: |
          pip install --upgrade yfinance pandas google-generativeai

      - name: Run Scanner
        if: steps.timecheck.outputs.run == 'yes'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scanner.py

      # ğŸ“§ ìŠ¤ìºë„ˆ ì‹¤í–‰ + ê²°ê³¼ ìˆì„ ë•Œë§Œ ë©”ì¼
      - name: Send Mail
        if: steps.timecheck.outputs.run == 'yes'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: toyoo1004@gmail.com
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ğŸ¯ ì˜¤ëŠ˜ì˜ Gemini ì£¼ì‹ ë¶„ì„ ë¦¬í¬íŠ¸"
          to: toyoo1004@gmail.com
          from: Stock AI Bot
          body: |
            Geminiê°€ ë¶„ì„í•œ ì˜¤ëŠ˜ì˜ ì¢…ê°€ ë§¤ìˆ˜ í›„ë³´ì…ë‹ˆë‹¤.
            ì²¨ë¶€ëœ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
          attachments: result.txt
