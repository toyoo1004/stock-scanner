name: Daily Stock Scan

on:
  schedule:
    # âœ… í…ŒìŠ¤íŠ¸ìš©: KST 16:10 ~ 16:15
    - cron: '10-15 7 * * *'

    # âœ… ë³¸ ì‹¤í–‰ìš© (ì¢…ê°€ ë§¤ìˆ˜): KST 05:40 ~ 05:45
    - cron: '40-45 20 * * *'

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ðŸ”¥ KST ì‹œê°„ ìœˆë„ìš° ì²´í¬ (cron ì˜¤ì°¨ ì™„ì „ ë°©ì–´)
      - name: Time window check (KST)
        run: |
          HOUR=$(TZ=Asia/Seoul date +%H)
          MIN=$(TZ=Asia/Seoul date +%M)

          NOW=$((10#$HOUR * 60 + 10#$MIN))

          TEST_START=$((16 * 60 + 10))
          TEST_END=$((16 * 60 + 15))

          MAIN_START=$((5 * 60 + 40))
          MAIN_END=$((5 * 60 + 45))

          if (( NOW >= TEST_START && NOW <= TEST_END )); then
            exit 0
          fi

          if (( NOW >= MAIN_START && NOW <= MAIN_END )); then
            exit 0
          fi

          exit 1

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install yfinance pandas google-generativeai

      # ðŸš« ë¡œê·¸ì— í‚¤ ì¶œë ¥ ê¸ˆì§€ (í™˜ê²½ë³€ìˆ˜ë§Œ ì£¼ìž…)
      - name: Run Scanner
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python scanner.py

      # ðŸ“§ ì„±ê³µ ì‹œì—ë§Œ ë©”ì¼ ë°œì†¡
      - name: Send Mail
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: toyoo1004@gmail.com
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸŽ¯ ì˜¤ëŠ˜ì˜ Gemini ì£¼ì‹ ë¶„ì„ ë¦¬í¬íŠ¸"
          to: toyoo1004@gmail.com
          from: Stock AI Bot
          body: |
            Geminiê°€ ë¶„ì„í•œ ì˜¤ëŠ˜ì˜ ì¢…ê°€ ë§¤ìˆ˜ í›„ë³´ìž…ë‹ˆë‹¤.
            ì²¨ë¶€ëœ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
          attachments: result.txt
