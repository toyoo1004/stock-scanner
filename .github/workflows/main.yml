name: Daily Stock Scan

on:
  schedule:
    # âœ… í…ŒìŠ¤íŠ¸ìš©: KST 16:10 ~ 16:15
    - cron: '10-15 7 * * *'

    # âœ… ë³¸ ì‹¤í–‰ìš© (ì¢…ê°€ ë§¤ìˆ˜): KST 05:40 ~ 05:45
    - cron: '40-45 20 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ðŸ”¥ í•µì‹¬: KST ì‹œê°„ ìœˆë„ìš° ì²´í¬ (cron ì˜¤ì°¨ ì™„ì „ ë°©ì–´)
      - name: Time window check (KST)
        run: |
          HOUR=$(TZ=Asia/Seoul date +%H)
          MIN=$(TZ=Asia/Seoul date +%M)

          NOW=$((10#$HOUR * 60 + 10#$MIN))

          TEST_START=$((16 * 60 + 10))   # 16:10
          TEST_END=$((16 * 60 + 15))     # 16:15

          MAIN_START=$((5 * 60 + 40))   # 05:40
          MAIN_END=$((5 * 60 + 45))     # 05:45

          echo "ðŸ•’ Current KST time: ${HOUR}:${MIN} (minutes=$NOW)"

          if (( NOW >= TEST_START && NOW <= TEST_END )); then
            echo "âœ… í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„"
            exit 0
          fi

          if (( NOW >= MAIN_START && NOW <= MAIN_END )); then
            echo "âœ… ë³¸ ì‹¤í–‰ ì‹œê°„ (ì¢…ê°€ ë§¤ìˆ˜)"
            exit 0
          fi

          echo "â­ ì‹¤í–‰ ì‹œê°„ ì•„ë‹˜ â†’ ì¢…ë£Œ"
          exit 1

      - name: Install dependencies
        run: |
          pip install --upgrade yfinance pandas google-generativeai

      - name: Run Scanner
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scanner.py

      # ðŸ“§ ìŠ¤ìºë„ˆ ì •ìƒ ì‹¤í–‰ ì‹œì—ë§Œ ë©”ì¼ ë°œì†¡
      - name: Send Mail
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: toyoo1004@gmail.com
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸŽ¯ ì˜¤ëŠ˜ì˜ Gemini ì£¼ì‹ ë¶„ì„ ë¦¬í¬íŠ¸"
          to: toyoo1004@gmail.com
          from: Stock AI Bot
          body: |
            Geminiê°€ ë¶„ì„í•œ ì˜¤ëŠ˜ì˜ ì¢…ê°€ ë§¤ìˆ˜ í›„ë³´ìž…ë‹ˆë‹¤.
            ì²¨ë¶€ëœ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
          attachments: result.txt
