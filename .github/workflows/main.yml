name: Daily Stock Scan

on:
  schedule:
    # âœ… í…ŒìŠ¤íŠ¸ìš©: KST 16:00 ~ 16:05
    - cron: '0-5 7 * * *'

    # âœ… ë³¸ ì‹¤í–‰ìš© (ì¢…ê°€ ë§¤ìˆ˜): KST 05:40 ~ 05:45
    - cron: '40-45 20 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ðŸ”¥ í•µì‹¬: KST ì‹œê°„ ìœˆë„ìš° ì²´í¬ (cron ì˜¤ì°¨ ë°©ì–´)
      - name: Time window check (KST)
        run: |
          KST_TIME=$(TZ=Asia/Seoul date +%H:%M)
          echo "ðŸ•’ Current KST time: $KST_TIME"

          # í…ŒìŠ¤íŠ¸ ìœˆë„ìš°
          if [[ "$KST_TIME" >= "16:00" && "$KST_TIME" <= "16:05" ]]; then
            echo "âœ… í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„"
            exit 0
          fi

          # ë³¸ ì‹¤í–‰ ìœˆë„ìš° (ì¢…ê°€ ë§¤ìˆ˜)
          if [[ "$KST_TIME" >= "05:40" && "$KST_TIME" <= "05:45" ]]; then
            echo "âœ… ë³¸ ì‹¤í–‰ ì‹œê°„ (ì¢…ê°€ ë§¤ìˆ˜)"
            exit 0
          fi

          echo "â­ ì‹¤í–‰ ì‹œê°„ ì•„ë‹˜ â†’ ì¢…ë£Œ"
          exit 1

      - name: Install dependencies
        run: |
          pip install --upgrade yfinance pandas google-generativeai
          # í–¥í›„ í•„ìš” ì‹œ google-genai ë¡œ ë³€ê²½ ê°€ëŠ¥

      - name: Run Scanner
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scanner.py

      # ðŸ“§ ì„±ê³µ ì‹œì—ë§Œ ë©”ì¼ ë°œì†¡
      - name: Send Mail
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: toyoo1004@gmail.com
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸŽ¯ ì˜¤ëŠ˜ì˜ Gemini ì£¼ì‹ ë¶„ì„ ë¦¬í¬íŠ¸"
          to: toyoo1004@gmail.com
          from: Stock AI Bot
          body: |
            Geminiê°€ ë¶„ì„í•œ ì˜¤ëŠ˜ì˜ ì¢…ê°€ ë§¤ìˆ˜ í›„ë³´ìž…ë‹ˆë‹¤.
            ì²¨ë¶€ëœ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
          attachments: result.txt
